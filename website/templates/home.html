{% extends "base.html" %}
{% block title %}Home{% endblock %}

{% block content %}
<div class="dashboard">
  <h1>Hi {{ current_user.first_name }}!</h1>

  <!-- Google Calendar Section -->
  <div class="card">
    <h3>ðŸ“… Upcoming Google Calendar Events</h3>
    {% if events %}
      {% for event in events %}
        <div class="task">
          <strong>{{ event.summary }}</strong><br>
          {{ event.start }}<br>
          {{ event.location }}
        </div>
      {% endfor %}
    {% else %}
      <p>No upcoming events found.</p>
    {% endif %}
  </div>

  <button class="button pink">View Tasks</button>
  <button class="button purple">View Grades</button>

  <div class="time-box" id="local-time">
    Loading time...
  </div>

  <!-- Notes Section -->
  <div class="card" style="margin-top: 40px; text-align: left;">
    <h2 align="center">Notes</h2>
    <ul class="list-group list-group-flush" id="notes">
      {% for note in user.notes %}
        <li class="list-group-item" id="note-{{ note.id }}" style="display: flex; justify-content: space-between; align-items: center;">
          {{ note.data }}
          <button type="button" class="close" onclick="deleteNote({{ note.id }})">
            <span aria-hidden="true">&times;</span>
          </button>
        </li>
      {% endfor %}
    </ul>

    <form method="POST" id="note-form">
      <textarea name="note" id="note" class="form-control" placeholder="Write your note here..."></textarea>
      <br />
      <div align="center">
        <button type="submit" class="button green">Add Note</button>
      </div>
    </form>
    <div id="note-feedback" style="text-align: center; margin-top: 0.5rem;"></div>
  </div>
</div>

<!-- JavaScript for Clock and Notes -->
<script>
function updateTime() {
  const options = {
    timeZone: "Australia/Sydney",
    hour: '2-digit',
    minute: '2-digit',
    hour12: true,
    weekday: 'long'
  };
  const now = new Date();
  const timeString = now.toLocaleTimeString('en-AU', options);
  const parts = timeString.split(' ');
  const hourMin = parts[0];
  const meridian = parts[1];
  const day = parts[2]?.toUpperCase() || "";
  document.getElementById("local-time").innerText = `${hourMin} ${meridian} ${day}`;
}
updateTime();
setInterval(updateTime, 30000);

// Delete note without page refresh
function deleteNote(noteId) {
  fetch("/delete-note", {
    method: "POST",
    body: JSON.stringify({ noteId: noteId }),
    headers: {
      "Content-Type": "application/json"
    }
  }).then(response => response.json())
    .then(data => {
      if (data.success) {
        const noteElement = document.getElementById(`note-${noteId}`);
        if (noteElement) {
          noteElement.remove();
        }
      } else {
        alert("Failed to delete note.");
      }
    });
}
</script>
{% endblock %}
